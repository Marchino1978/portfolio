<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARKET LIVE</title>
    <style>
        body { 
            background-color: #000; color: #fff; font-family: 'Courier New', monospace; 
            margin: 0; padding: 0; overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; 
        }

        /* ########################################
           # LOGICA COLORI DINAMICI (OPEN/CLOSED)
           # Qui puoi cambiare le palette colori
           ######################################## */
        :root {
            /* COLORI STANDARD (MARKET OPEN) */
            --color-pos: #00ff41;    /* VERDE GIORNO */
            --color-neg: #ff0000;    /* ROSSO GIORNO */
            --color-na:  #00ffff;    /* CIANO GIORNO */
            --color-btn: #ff8c00;    /* ARANCIO BOTTONI */
            --btn-bg:    #221500;    /* SFONDO BOTTONI PREMUTI */
        }

        .bloomberg-mode {
            /* COLORI BLOOMBERG (MARKET CLOSED) */
            --color-pos: #ffb000;    /* AMBRA (Positivi) */
            --color-neg: #00ffff;    /* CIANO (Negativi) */
            --color-na:  #888888;    /* GRIGIO PERLA */
            --color-btn: #8a2be2;    /* VIOLA PROFONDO */
            --btn-bg:    #120024;    /* SFONDO VIOLA SCURO */
        }

        /* ########################################
           # BANNER MARKET CLOSED
           ######################################## */
        #market-status-alert {
            display: none;
            position: fixed;
            bottom: 45px;
            right: 25px;
            background-color: yellow;
            color: red;
            font-weight: bold;
            padding: 5px 15px;
            border: 2px solid red;
            font-size: 18px;
            z-index: 1000;
            text-transform: uppercase;
        }

        .blink-text {
            animation: blinker 1.2s linear infinite;
        }

        @keyframes blinker {
            50% { opacity: 0.1; }
        }

        /* ########################################
           # STILE PULSANTI (IN LINEA)
           ######################################## */
        .controls { 
            margin-bottom: 25px; display: flex; flex-direction: row; 
            gap: 15px; justify-content: center; width: 100%;
        }

        .btn {
            background: #111; border: 2px solid #333; color: #555;            
            padding: 12px 24px; cursor: pointer; font-weight: bold; 
            border-radius: 6px; font-size: 32px; text-transform: uppercase; white-space: nowrap;
            transition: all 0.3s ease;
        }

        .btn.active { 
            border-color: var(--color-btn); 
            color: var(--color-btn); 
            box-shadow: 0 0 15px var(--color-btn); 
            background: var(--btn-bg);   
        }

        /* ########################################
           # FASCIA LED E GRIGLIA (OTTIMIZZATA PI 400)
           ######################################## */
        .ticker-container {
            width: 100%; height: 220px; background: #000; 
            border-top: 4px solid #1a1a1a; border-bottom: 4px solid #1a1a1a;
            display: flex; align-items: center; overflow: hidden; position: relative;
            background-image: radial-gradient(circle, #111 1px, transparent 1px); background-size: 10px 10px; 
        }

        .marquee {
            white-space: nowrap; position: absolute; font-size: 85px; font-weight: bold;
            display: flex; gap: 120px; padding-left: 20px;
            will-change: transform; transform: translate3d(0,0,0);
        }

        /* ########################################
           # VELOCITA' SCORRIMENTO (35s)
           ######################################## */
        .marquee-active { animation: scroll 35s linear infinite; }

        @keyframes scroll { 
            from { transform: translate3d(0, 0, 0); } 
            to { transform: translate3d(-50%, 0, 0); } 
        }

        .item { display: flex; gap: 25px; align-items: center; }
        .val-pos { color: var(--color-pos); text-shadow: 2px 2px 5px #000; }
        .val-neg { color: var(--color-neg); text-shadow: 2px 2px 5px #000; }
        .val-na  { color: var(--color-na);  text-shadow: 2px 2px 5px #000; }

        .update-time { position: fixed; bottom: 20px; right: 25px; color: #222; font-size: 14px; }
    </style>
</head>
<body id="main-body">

    <div id="market-status-alert"><span class="blink-text">MARKET CLOSED</span></div>
    <div class="controls" id="buttons"></div>
    <div class="ticker-container">
        <div class="marquee" id="ticker-content">...</div>
    </div>
    <div class="update-time" id="last-update"></div>

<script>
    /* ########################################
       # CONFIGURAZIONE API E NTP
       ######################################## */
    const url = 'https://raw.githubusercontent.com/Marchino1978/portfolio/refs/heads/main/data/market.json';
    const legenda = { 'D': '1 DAY', 'W': '1 WEEK', 'M': '1 MONTH', 'Q': '3 MONTHS', 'H': '6 MONTHS', 'Y': '1 YEAR', '3': '3 YEARS', '5': '5 YEARS' };
    
    let marketData = [];
    let currentMode = 'v1'; 

    // ########################################
    // # CONTROLLO TEMA & CHIUSURA (ROMA TIME)
    // ########################################
    function checkMarketClosed() {
        const now = new Date();
        const roma = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Rome"}));
        
        const wday = roma.getDay(); // 0=Dom, 6=Sab
        const day = roma.getDate();
        const month = roma.getMonth() + 1;
        const year = roma.getFullYear();
        const currentMin = roma.getHours() * 60 + roma.getMinutes();

        // 1. Weekend
        if (wday === 0 || wday === 6) return true;

        // 2. Orari (07:10 - 22:55) -> (430 e 1375 min)
        if (currentMin < 430 || currentMin > 1375) return true;

        // 3. FestivitÃ  Fisse
        const holidays = ["1-1", "25-4", "1-5", "2-6", "15-8", "25-12", "26-12"];
        if (holidays.includes(`${day}-${month}`)) return true;

        // 4. Pasqua e Pasquetta
        const a = year % 19, b = Math.floor(year / 100), c = year % 100;
        const d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4), k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const pMonth = Math.floor((h + l - 7 * m + 114) / 31);
        const pDay = ((h + l - 7 * m + 114) % 31) + 1;

        if (day === pDay && month === pMonth) return true;
        const pNext = new Date(year, pMonth - 1, pDay + 1);
        if (day === pNext.getDate() && month === (pNext.getMonth() + 1)) return true;

        return false;
    }

    function updateTheme() {
        const isClosed = checkMarketClosed();
        const body = document.getElementById('main-body');
        const alertBanner = document.getElementById('market-status-alert');
        
        if (isClosed) {
            body.classList.add('bloomberg-mode');
            alertBanner.style.display = 'block';
        } else {
            body.classList.remove('bloomberg-mode');
            alertBanner.style.display = 'none';
        }
    }

    async function fetchData() {
        try {
            updateTheme();
            const response = await fetch(url + '?t=' + Date.now());
            const json = await response.json();
            marketData = json.values.data;
            document.getElementById('last-update').innerText = "SYNC: " + json.last_updated.readable;
            
            if (document.getElementById('buttons').innerHTML === "") { createButtons(); }
            renderTicker();
        } catch (e) { console.error("Data Load Error"); }
    }

    // ########################################
    // # CREAZIONE PULSANTI DINAMICI
    // ########################################
    function createButtons() {
        const first = marketData[0];
        const modes = ['v1', 'v2', 'v3']; 
        const btnCont = document.getElementById('buttons');
        modes.forEach(m => {
            if (first[m]) {
                const char = first[m].slice(-1); 
                const b = document.createElement('div');
                b.className = `btn ${m === currentMode ? 'active' : ''}`;
                b.innerText = legenda[char] || char;
                b.onclick = () => {
                    document.querySelectorAll('.btn').forEach(x => x.classList.remove('active'));
                    b.classList.add('active');
                    currentMode = m;
                    renderTicker();
                };
                btnCont.appendChild(b);
            }
        });
    }

    // ########################################
    // # RENDER TICKER SCORREVOLE
    // ########################################
    function renderTicker() {
        const ticker = document.getElementById('ticker-content');
        ticker.classList.remove('marquee-active'); 
        
        let content = "";
        marketData.forEach(item => {
            let valRaw = item[currentMode];
            let valClean = valRaw.includes("N/A") || (!valRaw.startsWith('+') && !valRaw.startsWith('-')) ? "N/A" : valRaw.slice(0, -1);
            let colorClass = valClean === "N/A" ? "val-na" : (valClean.startsWith('+') ? "val-pos" : "val-neg");
            content += `<div class="item ${colorClass}"><span>${item.label.toUpperCase()}:</span><span>${valClean}</span></div>`;
        });
        
        ticker.innerHTML = content + content;
        setTimeout(() => { ticker.classList.add('marquee-active'); }, 100);
    }

    fetchData();
    setInterval(fetchData, 60000); 
</script>
</body>
</html>